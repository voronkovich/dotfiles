#!/usr/bin/env sh

find_file() {
    local file="${1}"
    local dir="${PWD}"

    while [ -n "${dir}" ]; do
        if [ -f "${dir}/${file}" ]; then
            echo "${dir}/${file}"
            return 0
        fi

        dir="${dir%/*}"
    done

    return 1
}

get_version() {
    local version_file="$(find_file .ansible-version)"

    if [ -n "${version_file}" ]; then
        cat "${version_file}"
    else
        echo "${ANSIBLE_VERSION:-alpine}"
    fi
}

readonly tag="$(get_version)"
readonly ssh_key="${ANSIBLE_SSH_KEY:-id_rsa}"

docker run --rm -it \
    -e ANSIBLE_HOST_KEY_CHECKING=False \
    -v "$(pwd):/ansible" \
    -v "${HOME}/.ssh/${ssh_key}:/root/.ssh/${ssh_key}:ro" \
    "willhallonline/ansible:${tag}" \
    "$@"
